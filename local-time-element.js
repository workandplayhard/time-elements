// Generated by CoffeeScript 1.6.3
(function() {
  var LocalTimePrototype, attachedInstances, formatFrom, ldml, parseISO8601, strftime, updateFromNowLocalTimeElements;

  ldml = {
    a: 'ddd',
    A: 'dddd',
    b: 'MMM',
    B: 'MMMM',
    d: 'DD',
    H: 'HH',
    I: 'hh',
    j: 'DDDD',
    m: 'MM',
    M: 'mm',
    p: 'A',
    S: 'ss',
    z: 'ZZ',
    w: 'd',
    y: 'YY',
    Y: 'YYYY',
    '%': '%'
  };

  strftime = function(date, format) {
    var key, momentFormat, value;
    momentFormat = format;
    for (key in ldml) {
      value = ldml[key];
      momentFormat = momentFormat.replace("%" + key, value);
    }
    return moment(date).format(momentFormat);
  };

  parseISO8601 = function(str) {
    var date;
    date = moment(str, 'YYYY-MM-DDTHH:mm:ssZ');
    if (date.isValid()) {
      return date.toDate();
    } else {
      return null;
    }
  };

  formatFrom = function(to, from) {
    var text;
    if (from == null) {
      from = Date.now();
    }
    text = moment(to).from(moment(from));
    if (text === "a few seconds ago") {
      return "just now";
    } else if (text === "in a few seconds") {
      return "just now";
    } else {
      return text;
    }
  };

  attachedInstances = [];

  LocalTimePrototype = Object.create(HTMLElement.prototype);

  LocalTimePrototype.createdCallback = function() {
    var value;
    if (value = this.getAttribute('datetime')) {
      this.attributeChangedCallback('datetime', null, value);
    }
    if (value = this.getAttribute('from')) {
      this.attributeChangedCallback('from', null, value);
    }
  };

  LocalTimePrototype.attributeChangedCallback = function(attrName, oldValue, newValue) {
    var text, title;
    if (attrName === 'datetime') {
      this._date = parseISO8601(newValue);
    }
    if (attrName === 'from') {
      if (newValue === 'now') {
        this._fromNowDate = true;
        this._fromDate = null;
      } else {
        this._fromNowDate = false;
        this._fromDate = parseISO8601(newValue);
      }
    }
    if (title = this.getFormattedTitle()) {
      this.setAttribute('title', title);
    }
    if (text = this.getFormattedDate() || this.getFormattedFromDate()) {
      this.textContent = text;
    }
  };

  LocalTimePrototype.attachedCallback = function() {
    attachedInstances.push(this);
  };

  LocalTimePrototype.detachedCallback = function() {
    var i;
    i = attachedInstances.indexOf(this);
    if (i !== -1) {
      attachedInstances.splice(i, 1);
    }
  };

  LocalTimePrototype.getFormattedDate = function() {
    if (this._date && this.hasAttribute('format')) {
      return strftime(this._date, this.getAttribute('format'));
    }
  };

  LocalTimePrototype.getFormattedFromDate = function() {
    if (this._date && this.hasAttribute('from')) {
      return formatFrom(this._date, this._fromDate);
    }
  };

  LocalTimePrototype.getFormattedTitle = function() {
    if (this._date && this.hasAttribute('title-format')) {
      return strftime(this._date, this.getAttribute('title-format'));
    }
  };

  updateFromNowLocalTimeElements = function() {
    var time, _i, _len;
    for (_i = 0, _len = attachedInstances.length; _i < _len; _i++) {
      time = attachedInstances[_i];
      if (time._date && time._fromNowDate) {
        time.textContent = time.getFormattedFromDate();
      }
    }
  };

  setInterval(updateFromNowLocalTimeElements, 60000);

  window.LocalTimeElement = document.registerElement('local-time', {
    prototype: LocalTimePrototype
  });

}).call(this);
